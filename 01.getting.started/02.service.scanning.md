# Service Scanning

## Nmap (Network Mapper)

Nmap is a network scanner created by Gordon Lyon. Nmap is used to discover hosts and services on a computer network by sending packets and analyzing the responses.

### Running a basic scan

    $ nmap 10.129.42.253

    Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:07 EST
    Nmap scan report for 10.129.42.253
    Host is up (0.11s latency).
    Not shown: 995 closed ports
    PORT    STATE SERVICE
    21/tcp  open  ftp
    22/tcp  open  ssh
    80/tcp  open  http
    139/tcp open  netbios-ssn
    445/tcp open  microsoft-ds

    Nmap done: 1 IP address (1 host up) scanned in 2.19 seconds

### A more informative scan

    $ nmap -sV -sC -p- 10.129.42.253

    Starting Nmap 7.80 ( https://nmap.org ) at 2021-02-25 16:18 EST
    Nmap scan report for 10.129.42.253
    Host is up (0.11s latency).
    Not shown: 65530 closed ports
    PORT    STATE SERVICE     VERSION
    21/tcp  open  ftp         vsftpd 3.0.3
    | ftp-anon: Anonymous FTP login allowed (FTP code 230)
    |_drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
    | ftp-syst: 
    |   STAT: 
    | FTP server status:
    |      Connected to ::ffff:10.10.14.2
    |      Logged in as ftp
    |      TYPE: ASCII
    |      No session bandwidth limit
    |      Session timeout in seconds is 300
    |      Control connection is plain text
    |      Data connections will be plain text
    |      At session startup, client count was 2
    |      vsFTPd 3.0.3 - secure, fast, stable
    |_End of status
    22/tcp  open  ssh         OpenSSH 8.2p1 Ubuntu 4ubuntu0.1 (Ubuntu Linux; protocol 2.0)
    80/tcp  open  http        Apache httpd 2.4.41 ((Ubuntu))
    |_http-server-header: Apache/2.4.41 (Ubuntu)
    |_http-title: PHP 7.4.3 - phpinfo()
    139/tcp open  netbios-ssn Samba smbd 4.6.2
    445/tcp open  netbios-ssn Samba smbd 4.6.2
    Service Info: OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel

    Host script results:
    |_nbstat: NetBIOS name: GS-SVCSCAN, NetBIOS user: <unknown>, NetBIOS MAC: <unknown> (unknown)
    | smb2-security-mode: 
    |   2.02: 
    |_    Message signing enabled but not required
    | smb2-time: 
    |   date: 2021-02-25T21:21:51
    |_  start_date: N/A

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    Nmap done: 1 IP address (1 host up) scanned in 233.68 seconds

| Parameter | Description |
| --------- | ----------- |
| -sC | specify that Nmap scripts should be used to try and obtain more detailed information. |
| -sV | instructs Nmap to perform a version scan by fingerprinting the target system and identify the service protocol, application name, and version. |
| -p- | tells Nmap that we want to scan all 65,535 TCP ports. |

### Running Nmap scripts

    $ nmap --script <script name> -p<port> <host>

Banner grabbing:

    $ nmap -sV --script=banner <target>

Or with netcat:

    $ nc -nv 10.129.42.253 21

    (UNKNOWN) [10.129.42.253] 21 (ftp) open
    220 (vsFTPd 3.0.3)

## FTP (File Transfer Protocol)

The File Transfer Protocol is a standard communication protocol used for the transfer of computer files from a server to a client on a computer network. FTP is built on a clientâ€“server model architecture using separate control and data connections between the client and the server. FTP users may authenticate themselves with a plain-text sign-in protocol, normally in the form of a username and password, but can connect anonymously if the server is configured to allow it.

### Connecting

    $ ftp -p 10.129.42.253

    Connected to 10.129.42.253.
    220 (vsFTPd 3.0.3)
    Name (10.129.42.253:user): anonymous
    230 Login successful.
    Remote system type is UNIX.
    Using binary mode to transfer files.

    ftp> ls
    227 Entering Passive Mode (10,129,42,253,158,60).
    150 Here comes the directory listing.
    drwxr-xr-x    2 ftp      ftp          4096 Feb 25 19:25 pub
    226 Directory send OK.

    ftp> cd pub
    250 Directory successfully changed.

    ftp> ls
    227 Entering Passive Mode (10,129,42,253,182,129).
    150 Here comes the directory listing.
    -rw-r--r--    1 ftp      ftp            18 Feb 25 19:25 login.txt
    226 Directory send OK.

    ftp> get login.txt
    local: login.txt remote: login.txt
    227 Entering Passive Mode (10,129,42,253,181,53).
    150 Opening BINARY mode data connection for login.txt (18 bytes).
    226 Transfer complete.
    18 bytes received in 0.00 secs (165.8314 kB/s)

    ftp> exit
    221 Goodbye.

## SMB (Server Message Block)

Server Message Block is a communication protocol used to share files, printers, serial ports, and miscellaneous communications between nodes on a network. On Microsoft Windows, the SMB implementation consists of two vaguely named Windows services: "Server" and "Workstation". It uses NTLM or Kerberos protocols for user authentication.

    $ nmap --script smb-os-discovery.nse -p445 10.10.10.40

    Starting Nmap 7.91 ( https://nmap.org ) at 2020-12-27 00:59 GMT
    Nmap scan report for doctors.htb (10.10.10.40)
    Host is up (0.022s latency).

    PORT    STATE SERVICE
    445/tcp open  microsoft-ds

    Host script results:
    | smb-os-discovery: 
    |   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
    |   OS CPE: cpe:/o:microsoft:windows_7::sp1:professional
    |   Computer name: CEO-PC
    |   NetBIOS computer name: CEO-PC\x00
    |   Workgroup: WORKGROUP\x00
    |_  System time: 2020-12-27T00:59:46+00:00

    Nmap done: 1 IP address (1 host up) scanned in 2.71 seconds

In this case, the host runs a legacy Windows 7 OS, and we could conduct further enumeration to confirm if it is vulnerable to EternalBlue.

### Shares

SMB allows users and administrators to share folders and make them accessible remotely by other users. Often these shares have files in them that contain sensitive information such as passwords.

Use **smbclient** to enumerate SMB shares:

    $ smbclient -N -L \\\\10.129.42.253

    Sharename       Type      Comment
    ---------       ----      -------
    print$          Disk      Printer Drivers
    users           Disk      
    IPC$            IPC       IPC Service (gs-svcscan server (Samba, Ubuntu))
    SMB1 disabled -- no workgroup available

| Parameter | Description |
| --------- | ----------- |
| -N | suppresses the password prompt. |
| -L | specifies that we want to retrieve a list of available shares on the remote host. |

Shares without a `$` at the end of their sharename indicates that share is not a default share.

Try logging in as a guest user:

    $ smbclient \\\\10.129.42.253\\users

Try logging in as a specific user (bob):

    $ smbclient -U bob \\\\10.129.42.253\\users

## SNMP (Simple Network Management Protocol)

SNMP Community strings provide information and statistics about a router or device, helping us gain access to it. The manufacturer default community strings of **public** and **private** are often unchanged. In SNMP versions 1 and 2c, access is controlled using a plaintext community string, and if we know the name, we can gain access to it. Encryption and authentication were only added in SNMP version 3.

### Scan public community string

    $ snmpwalk -v 2c -c public 10.129.42.253 1.3.6.1.2.1.1.5.0

    iso.3.6.1.2.1.1.5.0 = STRING: "gs-svcscan"

### Scan private community string

    $ snmpwalk -v 2c -c private  10.129.42.253 

    Timeout: No Response from 10.129.42.253

A tool such as **onesixtyone** can be used to brute force the community string names using a dictionary file of common community strings such as the **dict.txt** file included in the GitHub repo for the tool:

    $ onesixtyone -c dict.txt 10.129.42.254

    Scanning 1 hosts, 51 communities
    10.129.42.254 [public] Linux gs-svcscan 5.4.0-66-generic #74-Ubuntu SMP Wed Jan 27 22:54:38 UTC 2021 x86_64
